import{r as m,f as z,a as H,b as J,u as K,e as h,P as F,j as e,d as Q,F as W,p as w}from"./index-BZpdi1a7.js";import{u as X,C as $}from"./index.esm-D7bqcl31.js";import{T as Y}from"./Toast-CgtH5YQI.js";const u="https://new-json.onrender.com";function ae(){const[L,p]=m.useState(!0),{state:x,id:d}=z(),_=H(),[j,P]=m.useState(x),[n,D]=m.useState(null),[E,G]=m.useState(null),{user:c,user_token:T}=J(s=>s.userInfo);let f="";const N=K();c&&(f=c.user_id);const{register:R,handleSubmit:q,formState:{errors:o},control:b,reset:v}=X({defaultValues:{coment_star:0,game_id:Number(d),user_id:c?c.user_id:null,comment_isPass:null,comment_isSpoilered:null,coment_content:"",commet_played_time:""}}),g=m.useCallback(async s=>{var i;p(!0);try{const a=(await h.get(`${u}/gamesData/${s}`)).data;Array.isArray(a.game_img)&&(a.game_img=a.game_img[0]),D(a)}catch(t){console.log("取得遊戲資料錯誤：",(i=t.response.data)==null?void 0:i.errors[0])}finally{p(!1)}},[]),S=m.useCallback(async s=>{var i;p(!0);try{const a=(await h.get(`${u}/commentsData/${s}`)).data;(a.comment_id||a.id)&&a.user_id===c.user_id?(P("edit"),G(a),await g(a.game_id),v({coment_star:a.coment_star,game_id:a.game_id,user_id:a.user_id,comment_isPass:a.comment_isPass,comment_isSpoilered:a.comment_isSpoilered,coment_content:a.coment_content,commet_played_time:a.commet_played_time.slice(0,10)})):console.warn("取得的評論資料不符合當前使用者：",a)}catch(t){console.log("取得評論資料錯誤：",(i=t.response.data)==null?void 0:i.errors[0])}finally{p(!1)}},[v,c==null?void 0:c.user_id,g]),M=async s=>{var i;try{j==="new"?(await h.post(`${u}/commentsData`,s),v(),N(w({text:"新增評論成功！",status:"success"})),setTimeout(()=>{_(`/User_profile/${f}/myComments`)},3e3)):j==="edit"&&(await h.patch(`${u}/commentsData/${E.comment_id}`,s),N(w({text:"更新評論成功！",status:"success"})),setTimeout(()=>{_(`/User_profile/${f}/myComments`)},3e3))}catch(t){const a=(i=t.response.data)!=null&&i.errors[0]?"送出資料時發生錯誤":"";N(w({text:a,status:"failed"}))}},C=({value:s,onChange:i})=>e.jsx("div",{className:"box",children:[5,4,3,2,1].map(t=>[e.jsx("input",{type:"radio",id:`score${t}`,name:"star",value:t,checked:s===t,onChange:()=>i(t)},`input-${t}`),e.jsx("label",{htmlFor:`score${t}`},`label-${t}`)])});if(C.propTypes={value:F.number.isRequired,onChange:F.func.isRequired},m.useEffect(()=>{(()=>{c||_("/Login")})()},[c,_]),m.useEffect(()=>{(async()=>{var i;try{const[t,a,k]=await Promise.all([h.get(`${u}/commentsData`),h.get(`${u}/usersData`),h.get(`${u}/gamesData`)]),A=t.data,O=a.data,U=k.data.reduce((r,l)=>(r[l.game_id]=l,r),{}),I=O.reduce((r,l)=>(r[l.user_id]=l,r),{}),B=A.map(r=>({comment:r,game:U[r.game_id],user:I[r.user_id]}));if(x==="new"&&c&&d){const r=B.find(l=>l.comment.game_id===Number(d)&&l.comment.user_id===c.user_id);r&&_(`/Game_comment/edit/${r.comment.comment_id}`,{replace:!0})}}catch(t){console.log("取得相關資料錯誤：",(i=t.response.data)==null?void 0:i.errors[0])}})()},[d,x,c,_]),m.useEffect(()=>{x==="edit"?S(Number(d)):x==="new"&&g(Number(d))},[d,x,S,g]),(c==null?void 0:c.user_role)==="店家")return e.jsx("div",{className:"container-fluid container-lg",children:e.jsx("div",{className:"row justify-content-center",children:e.jsx("div",{className:"col-xl-10",children:e.jsx("div",{className:"pb-10",children:e.jsx("h2",{className:"text-center",children:"你是店家"})})})})});const y={coment_star:{required:"請給整體評價",min:{value:1,message:"評分最少 1 分"},max:{value:5,message:"評分最多 5 分"}},commet_played_time:{required:"請填寫遊玩日期",validate:s=>new Date(s)<=new Date||"日期不可晚於今天"},coment_content:{required:"請輸入心得內容",minLength:{value:10,message:"至少輸入 10 個字"},maxLength:{value:2e3,message:"勿超過 2000 字"}}};return L?e.jsx(Q,{message:"載入遊戲基本資料中"}):e.jsxs(e.Fragment,{children:[T&&e.jsx("div",{className:"bg-secondary-99",children:e.jsx("div",{className:"container-fluid container-lg",children:e.jsx("div",{className:"row justify-content-center",children:e.jsx("div",{className:"col-xl-10",children:e.jsxs("div",{className:"pb-10",children:[e.jsxs("picture",{className:"ratio ratio-16x9",children:[e.jsx("source",{media:"(min-width: 992px)",src:`${n==null?void 0:n.game_img}`}),e.jsx("img",{src:`${n==null?void 0:n.game_img}`,alt:"banner",className:"w-100 img-fluid rounded-3",style:{objectFit:"cover"}})]}),e.jsxs(W,{onSubmit:q(M),children:[e.jsx("div",{className:"py-10",children:e.jsxs("h1",{className:"fs-lg-Display2 fs-h5 fw-bold",children:["遊戲名稱：",`${n==null?void 0:n.game_name}`]})}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h2",{className:"fs-lg-h2 fs-h6 fw-bold",children:"整體評價"}),e.jsx("p",{className:"py-3",children:"依據您遊玩的經驗，整體而言您會給這個遊戲幾分?"}),e.jsx($,{name:"coment_star",rules:y.coment_star,control:b,render:({field:s})=>e.jsxs(e.Fragment,{children:[e.jsx(C,{value:s==null?void 0:s.value,onChange:s.onChange}),o.coment_star&&e.jsx("p",{className:"text-danger mt-1",children:o.coment_star.message})]})})]}),e.jsx("div",{children:e.jsxs("div",{children:[e.jsxs("div",{className:"row mb-6",children:[e.jsx("h2",{className:"fs-lg-h2 fs-h6 fw-bold",children:"難度與特色"}),e.jsxs("div",{className:"row py-3",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"難度"}),e.jsx("div",{className:"col-auto",children:`${n==null?void 0:n.game_dif_tagname}`})]}),e.jsxs("div",{className:"row py-3",id:"input_3_2",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"主題特色"}),e.jsx("div",{className:"col-lg-3 col-md-4 col-sm-6",children:`${n==null?void 0:n.game_main_tag1name} ${n==null?void 0:n.game_main_tag2name}`})]})]}),e.jsxs("div",{className:"row mb-6",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"遊玩日期"}),e.jsxs("div",{className:"col",children:[e.jsx("input",{type:"date",className:`form-control ${o.commet_played_time&&"is-invalid"}`,...R("commet_played_time",y.commet_played_time,{pattern:{value:/^\d{4}-(0[1-9]|1[012])-(0[1-9]|[12][0-9]|3[01])$/,message:"日期格式錯誤"}})}),o.commet_played_time&&e.jsx("div",{className:"invalid-feedback",children:o.commet_played_time.message})]})]}),e.jsxs("div",{className:"row mb-6",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"遊戲完成度"}),e.jsx($,{name:"comment_isPass",control:b,rules:{validate:s=>s!==null||"請選擇是否通關"},render:({field:s})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-auto",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:"inlineRadioOptions",id:"inlineRadioSuccess",checked:(s==null?void 0:s.value)===!0,onChange:()=>s.onChange(!0)}),e.jsx("label",{className:"form-check-label",htmlFor:"inlineRadioSuccess",children:"通關"})]}),e.jsxs("div",{className:"col-auto",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:"inlineRadioOptions",id:"inlineRadioFail",checked:(s==null?void 0:s.value)===!1,onChange:()=>s.onChange(!1)}),e.jsx("label",{className:"form-check-label",htmlFor:"inlineRadioFail",children:"未通關"})]}),o.comment_isPass&&e.jsx("p",{className:"text-danger mt-1",children:o.comment_isPass.message})]})})]}),e.jsxs("div",{className:"row mb-6",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"心得是否有劇透（暴雷）？"}),e.jsx($,{name:"comment_isSpoilered",control:b,rules:{validate:s=>s!==null||"請選擇是否含劇透"},render:({field:s})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"col-auto",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:"inlineRadioOptions2",id:"inlineRadioSuccess2",checked:(s==null?void 0:s.value)===!0,onChange:()=>s.onChange(!0)}),e.jsx("label",{className:"form-check-label",htmlFor:"inlineRadioSuccess2",children:"是"})]}),e.jsxs("div",{className:"col-auto",children:[e.jsx("input",{className:"form-check-input",type:"radio",name:"inlineRadioOptions2",id:"inlineRadioFail2",checked:(s==null?void 0:s.value)===!1,onChange:()=>s.onChange(!1)}),e.jsx("label",{className:"form-check-label",htmlFor:"inlineRadioFail2",children:"否"})]}),o.comment_isSpoilered&&e.jsx("p",{className:"text-danger mt-1",children:o.comment_isSpoilered.message})]})})]}),e.jsxs("div",{className:"row",children:[e.jsx("h3",{className:"fs-lg-h3 fs-h6 fw-bold pb-2",children:"體驗心得"}),e.jsxs("div",{className:"col",children:[e.jsx("textarea",{className:`form-control ${o.coment_content&&"is-invalid"}`,rows:"5",...R("coment_content",y.coment_content)}),e.jsx("label",{htmlFor:"experience",className:"form-label"}),o.coment_content&&e.jsx("div",{className:"invalid-feedback",children:o.coment_content.message})]})]}),e.jsx("div",{className:"col d-grid gap-2",children:e.jsx("button",{type:"submit",className:"btn commentBtn btn-secondary-60 link-white rounded-1",children:j==="new"?"送出評論":"更新評論"})})]})})]})]})})})})}),e.jsx(Y,{})]})}export{ae as default};
